# $Id: Makefile.in,v 1.7 2007/08/23 09:36:04 rjones Exp $

PACKAGE		= @PACKAGE_NAME@
VERSION		= @PACKAGE_VERSION@

INSTALL		= @INSTALL@

pkg_lablgtk2	= @pkg_lablgtk2@
pkg_curses	= @pkg_curses@

OCAMLDOCFLAGS	:= -html -sort

SUBDIRS		:= libvirt examples mlvirsh

ifeq ($(pkg_lablgtk2),yes)
SUBDIRS		+= mlvirtmanager
endif

ifeq ($(pkg_curses),yes)
SUBDIRS		+= virt-top
endif

all opt depend install:
	for d in $(SUBDIRS); do \
	  $(MAKE) -C $$d $@; \
	  if [ $$? -ne 0 ]; then exit 1; fi; \
	done

clean:
	for d in . $(SUBDIRS); do \
	  (cd $$d; rm -f *.cmi *.cmo *.cmx *.cma *.cmxa *.o *.a *.so *.opt *~ core); \
	done
	rm -f examples/list_domains
	rm -f mlvirsh/mlvirsh
	rm -f mlvirtmanager/mlvirtmanager
	rm -f virt-top/virt-top

distclean:
	rm -f config.h config.log config.status configure META
	rm -rf autom4te.cache
	rm -f Makefile

# Distribution.

dist:
	$(MAKE) check-manifest
	rm -rf $(PACKAGE)-$(VERSION)
	mkdir $(PACKAGE)-$(VERSION)
	tar -cf - -T MANIFEST | tar -C $(PACKAGE)-$(VERSION) -xf -
	$(INSTALL) -m 0755 configure $(PACKAGE)-$(VERSION)/
	tar zcf $(PACKAGE)-$(VERSION).tar.gz $(PACKAGE)-$(VERSION)
	rm -rf $(PACKAGE)-$(VERSION)
	ls -l $(PACKAGE)-$(VERSION).tar.gz

check-manifest:
	@for d in `find -type d -name CVS | grep -v '^\./debian/'`; \
	do \
	b=`dirname $$d`/; \
	awk -F/ '$$1 != "D" {print $$2}' $$d/Entries | \
	sed -e "s|^|$$b|" -e "s|^\./||"; \
	done | sort > .check-manifest; \
	sort MANIFEST > .orig-manifest; \
	diff -u .orig-manifest .check-manifest; rv=$$?; \
	rm -f .orig-manifest .check-manifest; \
	exit $$rv

# Developer documentation (in html/ subdirectory).

doc:
	rm -rf html
	mkdir html
	-cd libvirt; \
	ocamlfind ocamldoc $(OCAMLDOCFLAGS) -d ../html \
	  libvirt.{ml,mli} libvirt_version.{ml,mli}
