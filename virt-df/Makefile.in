# virt-df
# Copyright (C) 2007 Red Hat Inc., Richard W.M. Jones
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

PACKAGE		:= @PACKAGE_NAME@
VERSION		:= @PACKAGE_VERSION@

INSTALL		:= @INSTALL@
HAVE_PERLDOC	:= @HAVE_PERLDOC@

prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@

pkg_gettext     = @pkg_gettext@

#OCAMLCPACKAGES	:= -package unix,extlib,xml-light,bitmatch
OCAMLCPACKAGES	:= -package unix,extlib,xml-light -I +bitmatch

ifneq ($(pkg_gettext),no)
OCAMLCPACKAGES  += -package gettext-stub
endif

OBJS		:= \
	virt_df_gettext.cmo \
	virt_df.cmo \
	virt_df_ext2.cmo \
	virt_df_linux_swap.cmo \
	virt_df_lvm2_metadata.cmo \
	virt_df_lvm2_parser.cmo \
	virt_df_lvm2_lexer.cmo \
	virt_df_lvm2.cmo \
	virt_df_mbr.cmo \
	virt_df_main.cmo

XOBJS		:= $(OBJS:.cmo=.cmx)

SYNTAX		:= -pp "camlp4o -I`ocamlc -where`/bitmatch pa_bitmatch.cmo"

OCAMLCPACKAGES  += -I ../libvirt
OCAMLCFLAGS	:= -g -w s $(SYNTAX)
#OCAMLCLIBS	:= -linkpkg
OCAMLCLIBS	:= -linkpkg bitmatch.cma

OCAMLOPTPACKAGES := $(OCAMLCPACKAGES)
OCAMLOPTFLAGS	:= -w s $(SYNTAX)
#OCAMLOPTLIBS	:= $(OCAMLCLIBS)
OCAMLOPTLIBS	:= -linkpkg bitmatch.cmxa

OCAMLDEPFLAGS	:= $(SYNTAX)

export LIBRARY_PATH=../libvirt
export LD_LIBRARY_PATH=../libvirt

BYTE_TARGETS	:= virt-df
OPT_TARGETS	:= virt-df.opt

ifeq ($(HAVE_PERLDOC),perldoc)
BYTE_TARGETS	+= virt-df.1 virt-df.txt
endif

all: $(BYTE_TARGETS)

opt: $(OPT_TARGETS)

virt-df: $(OBJS)
	ocamlfind ocamlc $(OCAMLCPACKAGES) $(OCAMLCFLAGS) $(OCAMLCLIBS) \
	  ../libvirt/mllibvirt.cma -o $@ $^

virt-df.opt: $(XOBJS)
	ocamlfind ocamlopt \
	  $(OCAMLOPTPACKAGES) $(OCAMLOPTFLAGS) $(OCAMLOPTLIBS) \
	  ../libvirt/mllibvirt.cmxa -o $@ $^

# 'make depend' doesn't catch these dependencies because the .mli file
# is auto-generated.
virt_df_lvm2_parser.cmo: virt_df_lvm2_parser.mli
virt_df_lvm2_parser.cmx: virt_df_lvm2_parser.mli

# Manual page.
ifeq ($(HAVE_PERLDOC),perldoc)
virt-df.1: virt-df.pod
	pod2man -c "Virtualization Support" --release "$(PACKAGE)-$(VERSION)" \
		$< > $@

virt-df.txt: virt-df.pod
	pod2text $< > $@
endif

install:
	if [ -x virt-df.opt ]; then \
	  mkdir -p $(DESTDIR)$(bindir); \
	  $(INSTALL) -m 0755 virt-df.opt $(DESTDIR)$(bindir)/virt-df; \
	fi

include ../Make.rules
